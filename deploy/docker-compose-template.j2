{% set PROJECT_ROOT = '/home/admin/' + PROJECT_SLUG %}
{% set VIRTUAL_ENV = PROJECT_ROOT + '/venv' %}
version: "3"
services:
  {{ PROJECT_SLUG }}-backend-{{ ENV }}:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
      args:
        PROJECT_SLUG: {{ PROJECT_SLUG }}
        PROJECT_USER: admin
        VIRTUAL_ENV: {{ VIRTUAL_ENV }}
    image: igorezersky/{{ PROJECT_SLUG }}:{{ ENV }}
    container_name: {{ PROJECT_SLUG }}-backend-{{ ENV }}
    restart: always
    expose:
      - "{{ PORT }}"
    networks:
      - {{ PROJECT_SLUG }}-{{ ENV }}
    {% if ENV == 'prod' %}
      - traefik-public
    labels:
      # Enable Traefik for this specific "backend" service
      - traefik.enable=true
      # Define the port inside of the Docker service to use
      - traefik.http.services.{{ PROJECT_SLUG }}-backend.loadbalancer.server.port={{ PORT }}
      # Make Traefik use this domain in HTTP
      - traefik.http.routers.{{ PROJECT_SLUG }}-backend-http.entrypoints=http
      - traefik.http.routers.{{ PROJECT_SLUG }}-backend-http.rule=Host(`{{ HOST }}`)
      # Use the traefik-public network (declared below)
      - traefik.docker.network=traefik-public
      # Make Traefik use this domain in HTTPS
      - traefik.http.routers.{{ PROJECT_SLUG }}-backend-https.entrypoints=https
      - traefik.http.routers.{{ PROJECT_SLUG }}-backend-https.rule=Host(`{{ HOST }}`)
      - traefik.http.routers.{{ PROJECT_SLUG }}-backend-https.tls=true
      # Use the "le" (Let's Encrypt) resolver
      - traefik.http.routers.{{ PROJECT_SLUG }}-backend-https.tls.certresolver=le
      # https-redirect middleware to redirect HTTP to HTTPS
      - traefik.http.middlewares.https-redirect.redirectscheme.scheme=https
      - traefik.http.middlewares.https-redirect.redirectscheme.permanent=true
      # Middleware to redirect HTTP to HTTPS
      - traefik.http.routers.{{ PROJECT_SLUG }}-backend-http.middlewares=https-redirect
    {% else %}
    ports:
      - {{ PORT }}:{{ PORT }}
    {% endif %}
    command: uvicorn run:server --port {{ PORT }} --host 0.0.0.0
    environment:
      HOST: {{ HOST }}
      PORT: {{ PORT }}
      ENABLE_CORS: "{{ ENABLE_CORS }}"
    volumes:
      - {{ VOLUMES_ROOT }}/logs:{{ PROJECT_ROOT }}/logs
networks:
  {{ PROJECT_SLUG }}-{{ ENV }}:
    name: {{ PROJECT_SLUG }}-{{ ENV }}
  {% if ENV == 'prod' %}
  traefik-public:
    external: true
  {% endif %}
